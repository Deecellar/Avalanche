const Position = @import("../board/position.zig");
const Piece = @import("../board/piece.zig");
const C = @import("../c.zig");

// Hand-Crafted Evaluation

pub const PieceValues: [12]i16 = .{
    95, // P
    370, // N
    390, // B
    590, // R
    1100, // Q
    0, // K
    -95, // p
    -370, // n
    -390, // b
    -590, // r
    -1100, // q
    -0, // k
};

pub const PieceValuesEg: [12]i16 = .{
    65, // P
    330, // N
    290, // B
    620, // R
    1100, // Q
    0, // K
    -65, // p
    -330, // n
    -290, // b
    -620, // r
    -1100, // q
    -0, // k
};

pub const PhaseValues: [6]i16 = .{
    0, // P
    1, // N
    1, // B
    2, // R
    4, // Q
    0, // K
};

// ^ 56 for black
// zig fmt: off
pub const PSQT: [6][64]i16 = .{
    // Pawn
    .{
        000, 000, 000, 000, 000, 000, 000, 000,
        150, 120, 120, 130, 130, 120, 120, 150,
        090, 060, 060, 070, 070, 060, 050, 090,
        012, 010, 015, 035, 032, -05, 005, 012,
        004, 003, 011, 020, 020, 008, -08, 003,
        005, 015, -02, 008, 008, -06, 013, 005,
        004, 005, 007, -09, -09, 010, 006, 004,
        000, 000, 000, 000, 000, 000, 000, 000,
    },
    // Knight
    .{
        -50, -40, -30, -30, -30, -30, -40, -50,
        -40, -20, 000, 000, 000, 000, -20, -40,
        -30, 000, 010, 015, 015, 010, 000, -30,
        -30, 000, 015, 020, 020, 015, 000, -30,
        -30, 000, 015, 017, 017, 015, 000, -30,
        -30, -20, 006, 015, 015, 010, -20, -30,
        -40, -20, 000, 000, 000, 000, -20, -40,
        -50, -40, -30, -30, -30, -30, -40, -50,
    },
    // Bishop
    .{
        -20, -10, -10, -10, -10, -10, -10, -20,
        -10, 000, 000, 000, 000, 000, 000, -10,
        -10, 000, 005, 010, 010, 005, 000, -10,
        -10, 017, 005, 012, 012, 005, 017, -10,
        -10, 000, 015, 012, 012, 015, 000, -10,
        -10, 010, 010, 010, 010, 010, 010, -10,
        -10, 016, 000, 000, 000, 000, 016, -10,
        -20, -10, -10, -10, -10, -10, -10, -20,
    },
    // Rook
    .{
        000, 000, 000, 003, 003, 000, 000, 000,
        005, 010, 014, 014, 014, 014, 010, 005,
        -05, 000, 000, 000, 000, 000, 000, -05,
        -05, 000, 000, 000, 000, 000, 000, -05,
        -05, 000, 000, 000, 000, 000, 000, 002,
        001, 002, 000, 000, 000, 000, 004, 001,
        -05, 000, 000, 000, 000, 000, 000, -05,
        000, 000, 000, 007, 008, 003, 002, 000,
    },
    // Queen
    .{
        -20, -10, -10, -03, -03, -10, -10, -20,
        -10, 000, 000, 000, 000, 000, 000, -10,
        -10, 000, 005, 010, 010, 005, 000, -10,
        -01, 005, 005, 010, 010, 005, 005, -02,
        002, 000, 010, 010, 010, 010, 000, 000,
        -10, 010, 012, 010, 010, 010, 010, -10,
        -10, 005, 000, 000, 000, 000, 005, -10,
        -20, -10, -10, -01, -03, -10, -10, -20,
    },
    // King
    .{
        -10, 000, -05, -10, -10, -05, 000, -10,
        -03, 000, -05, -10, -10, -05, 000, -03,
        -05, 000, -10, -20, -20, -10, 000, -05,
        -05, -05, -10, -20, -20, -10, -05, -05,
        -05, -05, -10, -20, -20, -10, -05, -05,
        -05, -05, -10, -20, -20, -10, -05, -05,
        -05, -05, -10, -10, -08, -04, -05, -05,
        001, 012, 010, 000, 000, 004, 011, 003,
    }
};

pub const PSQT_EG: [6][64]i16 = .{
    // Pawn
    .{
        000, 000, 000, 000, 000, 000, 000, 000,
        250, 330, 350, 380, 380, 350, 330, 250,
        090, 110, 120, 135, 135, 120, 110, 090,
        030, 040, 045, 050, 050, 045, 040, 030,
        010, 020, 015, 020, 020, 015, 020, 010,
        005, 005, 005, 010, 010, 005, 005, 005,
        -20, -20, -10, -05, -05, -10, -20, -20,
        000, 000, 000, 000, 000, 000, 000, 000,
    },
    // Knight
    .{
        -50, -40, -30, -30, -30, -30, -40, -50,
        -40, -20, 000, 000, 000, 000, -20, -40,
        020, 050, 050, 055, 055, 050, 050, 020,
        000, 010, 015, 020, 020, 015, 010, 000,
        -30, 000, 015, 017, 017, 015, 000, -30,
        -30, -20, 000, 015, 015, 000, -20, -30,
        -40, -20, 000, 000, 000, 000, -20, -40,
        -50, -40, -30, -30, -30, -30, -40, -50,
    },
    // Bishop
    .{
        -20, -10, -10, -10, -10, -10, -10, -20,
        -10, 000, 000, 000, 000, 000, 000, -10,
        -10, 000, 005, 010, 010, 005, 000, -10,
        -10, 005, 005, 010, 010, 005, 005, -10,
        -10, 000, 015, 010, 010, 015, 000, -10,
        -10, 010, 010, 010, 010, 010, 010, -10,
        -10, 015, 000, 000, 000, 000, 015, -10,
        -20, -10, -10, -10, -10, -10, -10, -20,
    },
    // Rook
    .{
        020, 020, 020, 020, 020, 020, 020, 020,
        005, 010, 020, 030, 030, 020, 010, 005,
        -05, 000, 000, 010, 010, 000, 000, -05,
        -05, 000, 000, 000, 000, 000, 000, -05,
        -05, 000, 000, 000, 000, 000, 000, 002,
        001, 002, 000, 000, 000, 000, 004, 001,
        -05, 000, 000, 000, 000, 000, 000, -05,
        000, 000, 000, 000, 000, 000, 000, 000,
    },
    // Queen
    .{
        -20, -10, -10, -03, -03, -10, -10, -20,
        -10, 000, 000, 000, 000, 000, 000, -10,
        -10, 000, 005, 010, 010, 005, 000, -10,
        -01, 005, 005, 010, 010, 005, 005, -02,
        002, 000, 010, 010, 010, 010, 000, 000,
        -10, 010, 012, 010, 010, 010, 010, -10,
        -10, 005, 000, 000, 000, 000, 005, -10,
        -20, -10, -10, -01, -03, -10, -10, -20,
    },
    // King
    .{
        000, 000, -05, -10, -10, -05, 000, 000,
        -10, 030, -05, 000, 000, -05, 030, -10,
        -20, 000, 020, 030, 030, 020, 000, -20,
        -30, -05, 030, 040, 040, 030, -05, -30,
        -30, -05, 030, 040, 040, 030, -05, -30,
        -30, -05, 020, 030, 030, 020, -05, -30,
        -30, -25, -20, -05, -05, -20, -25, -30,
        -50, -40, -40, -30, -30, -40, -40, -50,
    }
};

// zig fmt: on

pub const OPEN_FILE_BONUS: i16 = 35;
pub const PASSED_PAWN_BONUS: i16 = 125;
pub const DOUBLED_PAWN_REDUCTION: i16 = 20;

pub fn evaluate(position: *Position.Position) i16 {
    var score: i16 = 0;

    for (position.mailbox) |p, i| {
        if (p == null) {
            continue;
        }
        score += PieceValues[@enumToInt(p.?)];
        if (p.?.color() == Piece.Color.White) {
            score += PSQT[@enumToInt(p.?) % 6][i];
        } else {
            score -= PSQT[@enumToInt(p.?) % 6][i ^ 56];
        }
    }

    var file: u8 = 0;
    while (file < 8) {
        var wbb = position.bitboards.WhitePawns & C.SQ_C.FILES[file];
        var bbb = position.bitboards.BlackPawns & C.SQ_C.FILES[file];

        var wbbcount = @popCount(u64, wbb);
        var bbbcount = @popCount(u64, bbb);

        if (wbbcount == 0) {
            if ((position.bitboards.BlackRooks | position.bitboards.BlackQueens) & C.SQ_C.FILES[file] != 0) {
                score -= OPEN_FILE_BONUS;
            }
        } else if (bbbcount == 0) {
            if ((position.bitboards.WhiteRooks | position.bitboards.WhiteQueens) & C.SQ_C.FILES[file] != 0) {
                score += OPEN_FILE_BONUS;
            }
        } else {
            if (wbbcount >= 2) {
                score -= DOUBLED_PAWN_REDUCTION * (wbbcount - 1);
            } else if (bbbcount >= 2) {
                score += DOUBLED_PAWN_REDUCTION * (bbbcount - 1);
            }
        }
        file += 1;
    }

    return score;
}
